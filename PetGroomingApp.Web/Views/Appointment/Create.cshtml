@model PetGroomingApp.Web.ViewModels.Appointment.AppointmentUserFormViewModel

@{
    ViewData["Title"] = "Book Appointment";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<partial name="_PageTitle" />

<section class="about_area">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <form asp-action="Create" method="post" class="bg-light p-4 rounded-4 shadow-sm border">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="Id" />
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

                    <!-- Step 1: Services -->
                    <div class="form-group mb-4">
                        <label class="fw-bold">1. Select Services</label>
                        <div class="d-flex flex-wrap gap-3 mt-2">
                            @foreach (var service in Model.Services)
                            {
                                <div class="form-check">
                                    <input id="@service.Value" type="checkbox" class="form-check-input" name="SelectedServiceIds" value="@service.Value"
                                           @(Model.SelectedServiceIds != null && Model.SelectedServiceIds.Contains(Guid.Parse(service.Value)) ? "checked" : "") />
                                    <label for="@service.Value" class="form-check-label">@service.Text</label>
                                </div>
                            }
                        </div>
                        <span asp-validation-for="SelectedServiceIds" class="text-danger"></span>
                    </div>

                    <!-- Step 2: Groomer -->
                    <div class="form-group mb-4">
                        <label class="fw-bold">2. Select Groomer</label>
                        <select id="SelectedGroomerId" asp-for="SelectedGroomerId" asp-items="Model.Groomers" class="form-select">
                            <option value="">Any Available Groomer</option>
                        </select>
                        <span asp-validation-for="SelectedGroomerId" class="text-danger"></span>
                    </div>

                    <!-- Step 3: Appointment Time -->
                    @* <div class="form-group mb-4">
                        <label class="fw-bold">3. Choose Date</label>
                        <input id="AppointmentDate" name="AppointmentDate" type="date" class="form-control" disabled />
                    </div>
                    <div class="form-group mb-4">
                        <label class="fw-bold">4. Choose Time</label>
                        <select id="AppointmentTime" name="AppointmentTime" class="form-select" disabled>
                            <option value="">Select time...</option>
                        </select>
                        <span asp-validation-for="AppointmentTime" class="text-danger"></span>
                    </div> *@
                    <div class="form-group mb-4">
                        <label class="fw-bold">3. Choose Available Time</label>
                        <select id="AppointmentTime" name="AppointmentTime" class="form-select" disabled>
                            <option value="">Select time...</option>
                        </select>
                        <span asp-validation-for="AppointmentTime" class="text-danger"></span>
                    </div>
                    @* <div class="form-group mb-4">
                        <label class="fw-bold">3. Choose Available Time</label>
                        <input id="AppointmentTime" asp-for="AppointmentTime" class="form-control" type="datetime-local" step="1800" disabled />
                        <span asp-validation-for="AppointmentTime" class="text-danger"></span>
                    </div> *@

                    <!-- Step 4: Pet -->
                    <div class="form-group mb-4">
                        <label class="fw-bold">4. Select Pet</label>
                        <select asp-for="SelectedPetId" asp-items="Model.Pets" class="form-select"></select>
                        <span asp-validation-for="SelectedPetId" class="text-danger"></span>
                    </div>

                    <!-- Step 5: Notes -->
                    <div class="form-group mb-4">
                        <label asp-for="Notes" class="fw-bold">5. Additional Notes</label>
                        <textarea asp-for="Notes" class="form-control" rows="2" placeholder="Notes (optional)"></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>

                    <!-- Summary -->
                    <div class="text-info mb-2">
                        Duration: <span id="durationValue">@Model.TotalDuration.ToString(@"hh\:mm")</span> hours
                    </div>
                    <div class="text-info mb-4">
                        Total Price: <span id="priceValue">@Model.TotalPrice.ToString("0.00")</span> €
                    </div>

                    <div class="d-flex justify-content-center gap-3">
                        <button type="submit" class="btn btn-success fw-bold px-4 rounded-pill">
                            <i class="bi bi-plus-circle"></i> Book
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary fw-semibold px-4 rounded-pill">
                            <i class="bi bi-arrow-left-circle"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/appointment-booking.js"></script>
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Disable calendar until groomer or services selected
        const timeInput = document.getElementById("AppointmentTime");
        //const groomerSelect = document.getElementById("SelectedGroomerId");
        const serviceCheckboxes = document.querySelectorAll("input[name='SelectedServiceIds']");

        function checkEnableTimeInput() {
            const servicesSelected = Array.from(serviceCheckboxes).some(cb => cb.checked);
            if (servicesSelected) {
                timeInput.disabled = false;
            } else {
                timeInput.disabled = true;
                timeInput.value = "";
            }
        }

        serviceCheckboxes.forEach(cb => cb.addEventListener("change", checkEnableTimeInput));
        groomerSelect.addEventListener("change", checkEnableTimeInput);

        // Patch jQuery validator for datetime-local
        if ($.validator && $.validator.methods) {
            const originalStep = $.validator.methods.step;
            $.validator.methods.step = function (value, element, param) {
                if (element.type === "datetime-local") return true;
                return originalStep.call(this, value, element, param);
            };
        }
    </script>
}
